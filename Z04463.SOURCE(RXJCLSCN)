/* REXX */

"FREE FI(INDD)"
"FREE FI(OUTDD)"
"ALLOC FI(OUTDD) DA('Z04463.OUTPUT(JOBDATA)') SHR REUSE"

EOF_FLAG = 'NO'
OUT_CTR = 0  /* LINES OF DATA WRITTEN */
LINE_CTR = 0  /* TOTAL LINES WRITTEN */
PDSNAME = 'Z04463.JCL'  /* PDS TO READ FROM/PERFORM PROGRAM ON */
LINESPACE.1 = " " /* BLANK LINE TO SEPARATE DATA */
SYSIN_END = 'NO'  /* USED TO SIGNAL THE END OF SYSIN INSTREAM DATA */

X = OUTTRAP('MEMLIST.')
"LISTDS '"PDSNAME"' MEMBERS"
X = OUTTRAP('OFF')

DO I = 7 TO MEMLIST.0
  MEMBER = STRIP(MEMLIST.I)
  DSET = PDSNAME||'('||MEMBER||')'
  DSETWRT.1 = DSET
  "EXECIO 1 DISKW OUTDD (STEM DSETWRT."
  LINE_CTR = LINE_CTR + 1
  "ALLOC FI(INDD) DA('"DSET"') SHR REUSE"
  "EXECIO 0 DISKR INDD (OPEN"

  EOF_FLAG = 'NO'
  DO WHILE EOF_FLAG = 'NO'
    "EXECIO 1 DISKR INDD"

    IF RC = 2 THEN
      DO
        "EXECIO 0 DISKR INDD (FINIS"
        "FREE FI(INDD)"
        "EXECIO 1 DISKW OUTDD (STEM LINESPACE."
        LINE_CTR = LINE_CTR + 1
        EOF_FLAG = 'YES'
      END
    ELSE
      DO
        PARSE PULL LINE.1
        SYSIN_END = 'NO'
        SELECT
          WHEN POS('NOTIFY=', LINE.1) > 0 THEN
            DO
            "EXECIO 1 DISKW OUTDD (STEM LINE."
            OUT_CTR = OUT_CTR + 1
            LINE_CTR = LINE_CTR + 1
            END

          WHEN WORDPOS('EXEC', LINE.1) > 0,
          | POS('DSN=', LINE.1) > 0 THEN
            DO
              "EXECIO 1 DISKW OUTDD (STEM LINE."
              OUT_CTR = OUT_CTR + 1
              LINE_CTR = LINE_CTR + 1
            END

          WHEN POS('//SYSIN', LINE.1) > 0,
            & POS('//SYSIN', LINE.1) < 2 THEN
            DO WHILE SYSIN_END = 'NO'
              "EXECIO 1 DISKW OUTDD (STEM LINE."
              OUT_CTR = OUT_CTR + 1
              LINE_CTR = LINE_CTR + 1
              IF POS('/'||'*', LINE.1) > 0 THEN
                SYSIN_END = 'YES'
              ELSE
                "EXECIO 1 DISKR INDD"
                IF RC = 0 THEN
                  PARSE PULL LINE.1
                ELSE
                SYSIN_END = YES
            END
          OTHERWISE
        END
      END
  END
END

IF OUT_CTR > 0 THEN
  DO
    "EXECIO 0 DISKW OUTDD (FINIS"
    SAY 'FILE NOW CONTAINS' OUT_CTR 'LINES.'
  END
ELSE
  DO
  "EXECIO 0 DISKW OUTDD (OPEN FINIS"
  SAY 'FILE IS NOW EMPTY.'
  END
"FREE FI(INDD)"
"FREE FI(OUTDD)"

/* UPDATE TAB-REC OCCURS NUMBER IN COBOL PROGRAM 'CBLJCLRP'
 WITH VALUE OF LINE_CTR */
OUT_CTR = 0
LINE_CTR = LINE_CTR + 10

"ALLOC FI(OUTDD) DA('Z04463.SOURCE(CBLJCLRP)') SHR REUSE"
"EXECIO 1 DISKRU OUTDD 26 (STEM LINE."
IF RC \= 0 THEN
  DO
    "EXECIO 0 DISKW OUTDD (FINIS"
    SAY 'COBOL PROGRAM READ UPDATE FAILED'
  END
ELSE
  IF POS('TAB-REC', LINE.1) > 0 THEN
    DO
      LINE.1='           05 TAB-REC        PIC X(80) OCCURS',
      LINE_CTR' TIMES VALUE SPACES.'
      "EXECIO 1 DISKW OUTDD (STEM LINE."
      OUT_CTR = OUT_CTR + 1
    END

IF OUT_CTR > 0 THEN
  "EXECIO 0 DISKW OUTDD (FINIS"
  SAY 'COBOL PROGRAM READ UPDATE AND WRITE SUCCESSFUL'

"FREE FI(OUTDD)"
EXIT
